# Healerbook

# 说明

该项目为基于 FFLogs 辅助治疗玩家规划减伤技能时间轴的 FF14 游戏工具。

## 基本概念

- [FFLogs](https://fflogs.com/):  用户可以将战斗日志上传，统计各种技能的使用情况和承受伤害，可以使用 GraphQL API 来查询数据。
- 减伤：指一类玩家可以使用的技能，能够直接或间接地减少玩家所承受的伤害，具体分为几种：
    - 目标百分比减伤：将目标（一般是 boss）的属性值或造成的伤害降低若干百分比
    - 非目标百分比减伤：如果玩家带有该 buff，则受到的伤害减少若干百分比
    - 盾值减伤：给玩家附加临时生命值
    
    当有多个减伤效果同时生效时，先使用乘算来计算所有百分比减伤，最后再使用盾值减伤抵消，最后得到最终伤害。
    举例：若现在生效的减伤效果为 10%, 5%, 1000 盾值，原始伤害为 10000，那么最终伤害为：10000*(1-10%)*(1-5%)-1000 = 7550
    具体减伤的生效情况可以在 FFLogs 提供的日志中呈现。
    
- CD: 冷却时间，每个减伤技能都有冷却时间，不能连续使用。
- AOE: 同时或在相近时间对玩家施放的伤害技能，规划减伤技能时间轴的核心目的就是通过合适的减伤技能让玩家能够承受 AOE 技能。
- 阶段 (Phase)：有些超长高难度副本分为连续的多个阶段（比如绝境战），每个阶段的持续时间是不确定的（主要取决于团队伤害），这让我们无法通过绝对时间来规划时间轴，而是要通过每个阶段开始时的某个标志性技能施放来定义一个“时间基准”，该阶段内的各种技能需要基于该基准进行偏移计算。

# 基础能力

本章中所列出的能力不直接提供给用户，但需要在工具中作为类似基础库的定位，提供给工具的业务逻辑来使用。

- FFLogs API Client: 负责与 FFLogs 交互数据
- 减伤技能列表：一份 FF14 游戏中所有玩家能够使用的减伤技能元数据列表。包括技能名，ID，可使用的职业，减伤类型，减伤值，冷却时间等信息。该数据的初始化由你搜索互联网信息之后总结出来，后续可人工或自动维护。
- 敌方使用的伤害技能 ID 与实际技能名映射：通过工具自动维护
- 每个副本的敌方伤害技能时间轴：可通过 FFLogs 日志生成或人工维护
- 每个副本的阶段信息：由 FFLogs 日志生成

# 业务功能

## 首页

首页有如下功能：

- 新建时间轴：选择副本 → 进入时间轴编辑器
- 打开最近编辑的时间轴：用户最近打开的若干时间轴会存储在 local storage 中，由用户从该列表里选择一个并进入时间轴编辑器
- 从文件打开：需要打开一个外部 json 文件，该文件由时间轴编辑器导出，然后进入时间轴编辑器
- 从 FFLogs 导入：粘贴一个 FFLogs 战斗日志链接，加载日志数据，然后进入时间轴编辑器
- TOP100：选择 FFLogs 网站上每个副本的治疗合计伤害前 100 个战斗日志数据，然后进入时间轴编辑器（该功能的数据源由后文提到的 TOP100 数据源提供）

## 时间轴编辑器

用户新建或加载一个时间轴时，该时间轴的元数据已确定，具体如下：

- 队伍阵容：该数据确定了可用的减伤技能
- 副本：决定了伤害技能时间轴

用户可看到一个二维时间轴视图：

- 纵轴为可使用的减伤技能列表
- 横轴为时间，沿着时间可以看到具体的伤害技能施放与减伤技能的持续时间和 CD。

用户可以在该视图上添加、删除、拖动技能，玩家所受到的伤害会实时计算。

用户可以将时间轴导出为 json 文件。

用户可以将时间轴导出为一个简单的 txt 总结文件，内容主要包括受到的 AOE 技能名以及该技能下对应的减伤技能。

## TOP100 数据源

本子系统实际上是一个运行在服务端的定时任务，该任务每隔一定时间从 FFLogs 遍历所有零式及绝境战副本的按照治疗合计伤害排序的前 100 个战斗日志，将这些数据作为预置数据供用户选择。